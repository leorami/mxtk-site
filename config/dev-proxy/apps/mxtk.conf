# ========= MXTK (Next.js at root; exposed behind /mxtk) =========

# --- allow Next dev internals at root (one app per domain) ---
location ^~ /_next/                  {
  proxy_http_version 1.1;
  proxy_set_header Host $host;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header X-Forwarded-Host $host;
  proxy_set_header Upgrade $http_upgrade;
  proxy_set_header Connection "upgrade";
  proxy_buffering off;
  proxy_read_timeout 300;
  proxy_send_timeout 300;
  proxy_pass http://mxtk-site-web-1:2000/_next/;
}
location ^~ /__nextjs_font/          { proxy_http_version 1.1; proxy_set_header Host $host; proxy_pass http://mxtk-site-web-1:2000/__nextjs_font/; }
location =   /__nextjs_original-stack-frames { proxy_http_version 1.1; proxy_set_header Host $host; proxy_pass http://mxtk-site-web-1:2000/__nextjs_original-stack-frames; }

# --- main /mxtk prefix (pages + public assets + /api) ---
location ~* ^/mxtk(?<rest>/.*)?$ {
  set $mxtk_rest $rest; if ($mxtk_rest = "") { set $mxtk_rest "/"; }
  proxy_http_version 1.1;
  proxy_set_header Host $host;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header X-Forwarded-Prefix /mxtk;
  proxy_set_header Upgrade $http_upgrade; proxy_set_header Connection "upgrade";
  proxy_buffering off;
  # Allow HTML rewriting
  proxy_set_header Accept-Encoding "";
  sub_filter_types text/html;
  sub_filter 'href="/' 'href="/mxtk/';
  sub_filter 'src="/' 'src="/mxtk/';
  sub_filter_once off;
  proxy_read_timeout 300; proxy_send_timeout 300;
  proxy_pass http://mxtk-site-web-1:2000$mxtk_rest;
}

# --- block everything else at root (except Next internals) ---
# Permit some root-level assets that SSR might reference absolutely
location ~* ^/(favicon\.ico|favicon\.svg)$ { proxy_set_header Host $host; proxy_pass http://mxtk-site-web-1:2000; }
location ^~ /icons/ { proxy_set_header Host $host; proxy_pass http://mxtk-site-web-1:2000; }
location ^~ /organizations/ { proxy_set_header Host $host; proxy_pass http://mxtk-site-web-1:2000; }
location ^~ /media/ { proxy_set_header Host $host; proxy_pass http://mxtk-site-web-1:2000; }

location ~ ^/(?!_next/|__nextjs_font/|__nextjs_original-stack-frames|mxtk|icons/|organizations/|media/|favicon\.(ico|svg)).+ { return 404; }
