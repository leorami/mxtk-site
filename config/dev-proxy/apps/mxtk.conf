location = /mxtk {
  proxy_set_header Host $host;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header X-Forwarded-Host $host;
  resolver 127.0.0.11 ipv6=off;
  resolver_timeout 5s;
  set $mxtk_site_dev host.docker.internal:2000;
  proxy_pass http://$mxtk_site_dev/mxtk;
}

# Preserve-mode for /mxtk: pass subpath through as-is to upstream
location ^~ /mxtk/_next/ {
  proxy_http_version 1.1;
  proxy_set_header Host $host;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header X-Forwarded-Host $host;
  proxy_set_header Upgrade $http_upgrade;
  proxy_set_header Connection "upgrade";
  proxy_read_timeout 300s;
  proxy_send_timeout 300s;
  resolver 127.0.0.11 ipv6=off;
  resolver_timeout 5s;
  set $mxtk_site_dev host.docker.internal:2000;
  proxy_pass http://$mxtk_site_dev;
}

location ^~ /mxtk/ {
  proxy_http_version 1.1;
  proxy_set_header Host $host;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header X-Forwarded-Host $host;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Prefix /mxtk;
  absolute_redirect off;
  proxy_redirect off;
  resolver 127.0.0.11 ipv6=off;
  resolver_timeout 5s;
  set $mxtk_site_dev host.docker.internal:2000;
  proxy_pass http://$mxtk_site_dev;
}

# Root-level Next font helper (Next 14+ emits /__nextjs_font/* at root)
location ^~ /__nextjs_font/ {
  proxy_set_header Host host.docker.internal:2000;
  resolver 127.0.0.11 ipv6=off;
  resolver_timeout 5s;
  set $mxtk_site_dev host.docker.internal:2000;
  rewrite ^/__nextjs_font/(.*)$ /mxtk/__nextjs_font/$1 break;
  proxy_pass http://$mxtk_site_dev;
}

# Root-level Next original stack frames (dev overlay)
location = /__nextjs_original-stack-frames {
  proxy_set_header Host host.docker.internal:2000;
  resolver 127.0.0.11 ipv6=off;
  resolver_timeout 5s;
  set $mxtk_site_dev host.docker.internal:2000;
  proxy_pass http://$mxtk_site_dev/mxtk/__nextjs_original-stack-frames;
}
