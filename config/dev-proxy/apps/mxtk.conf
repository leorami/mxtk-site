# ========= MXTK (Next.js at root; exposed behind /mxtk) =========

# --- allow Next dev internals at root (one app per domain) ---
location = /_next {
  add_header Cache-Control "no-store" always;
  return 204;
}
location = /_next/ {
  add_header Cache-Control "no-store" always;
  return 204;
}
location ^~ /_next/static/ {
  proxy_http_version 1.1;
  proxy_set_header Host $host;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto https;
  proxy_set_header X-Forwarded-Host $host;
  proxy_set_header X-Forwarded-Port 443;
  add_header Content-Security-Policy "upgrade-insecure-requests" always;
  proxy_buffering off;
  proxy_read_timeout 300;
  proxy_send_timeout 300;
  proxy_pass http://mxtk-site-dev:2000$request_uri;
}
location ^~ /_next/ {
  proxy_http_version 1.1;
  proxy_set_header Host $host;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto https;
  proxy_set_header X-Forwarded-Host $host;
  proxy_set_header X-Forwarded-Port 443;
  add_header Content-Security-Policy "upgrade-insecure-requests" always;
  proxy_set_header Upgrade $http_upgrade;
  proxy_set_header Connection "upgrade";
  proxy_buffering off;
  proxy_read_timeout 300;
  proxy_send_timeout 300;
  proxy_pass http://mxtk-site-dev:2000$request_uri;
}

# Handle both /mxtk and /mxtk/ by proxying to the app
location ~ ^/mxtk/?$ {
  proxy_http_version 1.1;
  proxy_set_header Host $host;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header X-Forwarded-Host $host;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Prefix /mxtk;
  proxy_set_header ngrok-skip-browser-warning true;
  proxy_buffering off;
  proxy_request_buffering off;
  proxy_read_timeout 300s;
  proxy_send_timeout 300s;
  resolver 127.0.0.11 ipv6=off;
  resolver_timeout 5s;
  set $mxtk_site_dev_mxtk mxtk-site-dev-mxtk:2000;
  proxy_pass http://$mxtk_site_dev_mxtk/mxtk;
}

# Handle bare _next directory (prevent redirect loop)
location = /mxtk/_next/ {
  proxy_http_version 1.1;
  proxy_set_header Host $host;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header X-Forwarded-Host $host;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Prefix /mxtk;
  resolver 127.0.0.11 ipv6=off;
  resolver_timeout 5s;
  set $mxtk_site_dev_mxtk mxtk-site-dev-mxtk:2000;
  proxy_pass http://$mxtk_site_dev_mxtk/mxtk/_next;
}

# Next.js assets and HMR - handle specific files
location ~ ^/mxtk/_next/(.+)$ {
  proxy_http_version 1.1;
  proxy_set_header Host $host;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header X-Forwarded-Host $host;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Prefix /mxtk;
  proxy_set_header Upgrade $http_upgrade;
  proxy_set_header Connection "upgrade";
  proxy_read_timeout 300s;
  proxy_send_timeout 300s;
  resolver 127.0.0.11 ipv6=off;
  resolver_timeout 5s;
  set $mxtk_site_dev_mxtk mxtk-site-dev-mxtk:2000;
  proxy_pass http://$mxtk_site_dev_mxtk/mxtk/_next/$1;
}

# Pages/RSC/data - more specific paths
location ~ ^/mxtk/.+ {
  proxy_http_version 1.1;
  proxy_set_header Host $host;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header X-Forwarded-Host $host;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Prefix /mxtk;
  proxy_set_header ngrok-skip-browser-warning true;
  proxy_buffering off;
  proxy_request_buffering off;
  proxy_read_timeout 300s;
  proxy_send_timeout 300s;
  resolver 127.0.0.11 ipv6=off;
  resolver_timeout 5s;
  set $mxtk_site_dev_mxtk mxtk-site-dev-mxtk:2000;
  proxy_pass http://$mxtk_site_dev_mxtk;
}

# --- Root-level redirects for relative URLs from the app ---
# When Next.js generates relative links, redirect them to /mxtk prefix
# Root-level redirects for app routes to /mxtk (defensive)
location ~ ^/(owners|institutions|transparency|ecosystem|whitepaper|faq|mxtk-cares|resources|legal|media|the-team|careers|contact-us|roadmap)(/.*)?$ {
  return 301 /mxtk$request_uri;
}

# Ensure /api redirects to /mxtk/api externally; internal mapping handled in app
location ~ ^/api/ {
  return 301 /mxtk$request_uri;
}

# Convenience for absolute-root public assets
location /icons/ {
  proxy_http_version 1.1;
  proxy_set_header Host $host;
  resolver 127.0.0.11 ipv6=off;
  resolver_timeout 5s;
  set $mxtk_site_dev_mxtk mxtk-site-dev-mxtk:2000;
  proxy_pass http://$mxtk_site_dev_mxtk/icons/;
}

# Redirect root-level assets to /mxtk prefix
location ~ ^/(art|organizations|minerals|media)(/.*)?$ {
  return 301 /mxtk$request_uri;
}

location ~ ^/logo-horizontal\.(png|svg)$ {
  return 301 /mxtk$request_uri;
}

location ~ ^/((robots\.txt|sitemap\.xml|manifest\.json|site\.webmanifest|apple-touch-icon\.png|favicon\.(ico|png|svg)))$ {
  proxy_http_version 1.1;
  proxy_set_header Host $host;
  resolver 127.0.0.11 ipv6=off;
  resolver_timeout 5s;
  set $mxtk_site_dev_mxtk mxtk-site-dev-mxtk:2000;
  proxy_pass http://$mxtk_site_dev_mxtk/$1;
}

# Block other root paths
location ~ ^/(?!_next/|mxtk/|owners|institutions|transparency|ecosystem|whitepaper|faq|mxtk-cares|resources|legal|media|the-team|careers|contact-us|roadmap|api/|art/|icons/|organizations/|minerals/|logo-horizontal|favicon).+ { 
  return 404; 
}