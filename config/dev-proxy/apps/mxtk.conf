location ~ ^/mxtk/?$ {
  proxy_http_version 1.1;
  proxy_set_header Host $host;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header X-Forwarded-Host $host;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Prefix /mxtk;
  proxy_set_header ngrok-skip-browser-warning true;
  proxy_buffering off;
  proxy_request_buffering off;
  proxy_read_timeout 300s;
  proxy_send_timeout 300s;
  resolver 127.0.0.11 ipv6=off;
  resolver_timeout 5s;
  proxy_pass http://mxtk-app:2000;
}

# Handle bare _next directory (prevent redirect loop)
location = /mxtk/_next/ {
  proxy_http_version 1.1;
  proxy_set_header Host $host;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header X-Forwarded-Host $host;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Prefix /mxtk;
  resolver 127.0.0.11 ipv6=off;
  resolver_timeout 5s;
  proxy_pass http://mxtk-app:2000/_next;
}

# Next.js assets and HMR - handle specific files
location ~ ^/mxtk/_next/(.+)$ {
  proxy_http_version 1.1;
  proxy_set_header Host $host;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header X-Forwarded-Host $host;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Prefix /mxtk;
  proxy_set_header Upgrade $http_upgrade;
  proxy_set_header Connection "upgrade";
  proxy_read_timeout 300s;
  proxy_send_timeout 300s;
  resolver 127.0.0.11 ipv6=off;
  resolver_timeout 5s;
  proxy_pass http://mxtk-app:2000/_next/$1;
}

# Convenience for public assets under subpath
location /mxtk/icons/ {
  proxy_http_version 1.1;
  proxy_set_header Host $host;
  resolver 127.0.0.11 ipv6=off;
  resolver_timeout 5s;
  proxy_pass http://mxtk-app:2000/icons/;
}

location ~ ^/mxtk/((robots\.txt|sitemap\.xml|manifest\.json|site\.webmanifest|apple-touch-icon\.png|favicon\.(ico|png|svg)))$ {
  proxy_http_version 1.1;
  proxy_set_header Host $host;
  resolver 127.0.0.11 ipv6=off;
  resolver_timeout 5s;
  proxy_pass http://mxtk-app:2000/$1;
}


location ~ ^/mxtk/.+ {
  proxy_http_version 1.1;
  proxy_set_header Host $host;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header X-Forwarded-Host $host;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Prefix /mxtk;
  proxy_set_header ngrok-skip-browser-warning true;
  # Enable HTML rewriting for SSR-emitted absolute paths
  proxy_set_header Accept-Encoding "";
  sub_filter_types text/html;
  sub_filter 'href="/' 'href="/mxtk/';
  sub_filter 'src="/'  'src="/mxtk/';
  sub_filter_once off;
  proxy_buffering off;
  proxy_request_buffering off;
  proxy_read_timeout 300s;
  proxy_send_timeout 300s;
  resolver 127.0.0.11 ipv6=off;
  resolver_timeout 5s;
  proxy_pass http://mxtk-app:2000;
}

## API under subpath: strip /mxtk when forwarding to upstream
location ^~ /mxtk/api/ai/ {
  proxy_http_version 1.1;
  proxy_set_header Host $host;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header X-Forwarded-Host $host;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Prefix /mxtk;
  proxy_set_header ngrok-skip-browser-warning true;
  proxy_buffering off;
  proxy_request_buffering off;
  proxy_read_timeout 300s;
  proxy_send_timeout 300s;
  resolver 127.0.0.11 ipv6=off;
  resolver_timeout 5s;
  proxy_pass http://mxtk-app:2000/api/ai/;
}

## Next assets are served under /mxtk when app sets basePath; no root rewrites needed

location = /mxtk/__nextjs_original-stack-frames {
  proxy_http_version 1.1;
  proxy_set_header Host $host;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header X-Forwarded-Host $host;
  resolver 127.0.0.11 ipv6=off;
  resolver_timeout 5s;
  proxy_pass http://mxtk-app:2000/__nextjs_original-stack-frames;
}


location ^~ /mxtk/api/ {
  proxy_http_version 1.1;
  proxy_set_header Host $host;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header X-Forwarded-Host $host;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Prefix /mxtk;
  proxy_buffering off;
  proxy_request_buffering off;
  resolver 127.0.0.11 ipv6=off;
  resolver_timeout 5s;
  proxy_pass http://mxtk-app:2000/api/;
}
