# ========= MXTK (Next.js at root; exposed behind /mxtk) =========

# --- allow Next dev internals at root (one app per domain) ---
location = /_next {
  add_header Cache-Control "no-store" always;
  return 204;
}
location = /_next/ {
  add_header Cache-Control "no-store" always;
  return 204;
}
location ^~ /_next/static/ {
  proxy_http_version 1.1;
  proxy_set_header Host $host;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto https;
  proxy_set_header X-Forwarded-Host $host;
  proxy_set_header X-Forwarded-Port 443;
  add_header Content-Security-Policy "upgrade-insecure-requests" always;
  proxy_buffering off;
  proxy_read_timeout 300;
  proxy_send_timeout 300;
  proxy_pass http://mxtk-site-dev:2000$request_uri;
}
location ^~ /_next/ {
  proxy_http_version 1.1;
  proxy_set_header Host $host;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto https;
  proxy_set_header X-Forwarded-Host $host;
  proxy_set_header X-Forwarded-Port 443;
  add_header Content-Security-Policy "upgrade-insecure-requests" always;
  proxy_set_header Upgrade $http_upgrade;
  proxy_set_header Connection "upgrade";
  proxy_buffering off;
  proxy_read_timeout 300;
  proxy_send_timeout 300;
  proxy_pass http://mxtk-site-dev:2000$request_uri;
}

# --- MXTK proxy: strip /mxtk prefix and forward to Next.js ---
location = /mxtk {
  # canonical trailing slash handled by app; pass directly to mxtk container
  proxy_http_version 1.1;
  proxy_set_header Host $host;
  proxy_set_header X-Forwarded-Proto https;
  proxy_set_header X-Forwarded-Host $host;
  proxy_set_header X-Forwarded-Port 443;
  proxy_set_header Upgrade $http_upgrade;
  proxy_set_header Connection "upgrade";
  proxy_buffering off;
  proxy_read_timeout 300;
  proxy_send_timeout 300;
  proxy_pass http://mxtk-site-dev-mxtk:2000/mxtk;
}

location ^~ /mxtk/_next/ {
  proxy_http_version 1.1;
  proxy_set_header Host $host;
  proxy_set_header X-Forwarded-Proto https;
  proxy_set_header X-Forwarded-Host $host;
  proxy_set_header X-Forwarded-Port 443;
  add_header Content-Security-Policy "upgrade-insecure-requests" always;
  proxy_set_header Upgrade $http_upgrade;
  proxy_set_header Connection "upgrade";
  proxy_buffering off;
  proxy_read_timeout 300;
  proxy_send_timeout 300;
  proxy_pass http://mxtk-site-dev-mxtk:2000/mxtk/_next/;
}

location ^~ /mxtk {
  proxy_http_version 1.1;
  proxy_set_header Host $host;
  proxy_set_header X-Forwarded-Proto https;
  proxy_set_header X-Forwarded-Host $host;
  proxy_set_header X-Forwarded-Port 443;
  add_header Content-Security-Policy "upgrade-insecure-requests" always;
  proxy_set_header Upgrade $http_upgrade;
  proxy_set_header Connection "upgrade";
  proxy_buffering off;
  proxy_read_timeout 300;
  proxy_send_timeout 300;
  # Do NOT strip /mxtk; app is configured with basePath=/mxtk
  proxy_pass http://mxtk-site-dev-mxtk:2000;
}

# --- Root-level redirects for relative URLs from the app ---
# When Next.js generates relative links, redirect them to /mxtk prefix
# Root-level redirects for app routes to /mxtk (defensive)
location ~ ^/(owners|institutions|transparency|ecosystem|whitepaper|faq|mxtk-cares|resources|legal|media|the-team|careers|contact-us|roadmap)(/.*)?$ {
  return 301 /mxtk$request_uri;
}

# Ensure /api redirects to /mxtk/api externally; internal mapping handled in app
location ~ ^/api/ {
  return 301 /mxtk$request_uri;
}

location ~ ^/(art|icons|organizations|minerals|media|logo-horizontal\.(png|svg))(/.*)?$ {
  return 301 /mxtk$request_uri;
}

# Root favicon - proxy directly (always accessible)
location ~* ^/(favicon\.ico|favicon\.svg)$ { 
  proxy_set_header Host $host; 
  proxy_set_header X-Forwarded-Proto https; 
  proxy_set_header X-Forwarded-Port 443; 
  proxy_pass http://mxtk-site-dev:2000$request_uri; 
}

# Block other root paths
location ~ ^/(?!_next/|mxtk/|owners|institutions|transparency|ecosystem|whitepaper|faq|mxtk-cares|resources|legal|media|the-team|careers|contact-us|roadmap|api/|art/|icons/|organizations/|minerals/|logo-horizontal|favicon).+ { 
  return 404; 
}